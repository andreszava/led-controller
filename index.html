<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>LED Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <h2>LED Controller</h2>

  <!-- ===== BLE CONNECTION ===== -->
  <button onclick="connectBLE()">Connect</button>
  <p>
    Status: <span id="status">Not connected</span><br>
    Device: <span id="deviceName">—</span>
  </p>

  <hr>

  <!-- ===== POWER ===== -->
  <button onclick="sendCommand('ON')">ON</button>
  <button onclick="sendCommand('OFF')">OFF</button>

  <hr>

  <!-- ===== MODES ===== -->
  <button onclick="sendCommand('MODE:RAINBOW')">Rainbow</button>
  <button onclick="sendCommand('MODE:CHASE')">Chase</button>
  <button onclick="sendCommand('MODE:BREATH')">Breath</button>
  <button onclick="sendCommand('MODE:AUDIO')">Audio Sync</button>

  <hr>

  <!-- ===== COLOR ===== -->
  <label>Color</label><br>
  <input type="color" onchange="sendColor(this.value)">

  <hr>

  <!-- ===== BRIGHTNESS ===== -->
  <label>
    Brightness: <span id="brightnessLabel">50%</span>
  </label><br>
  <input
    id="brightnessSlider"
    type="range"
    min="0"
    max="100"
    value="50"
    onchange="updateBrightness(this.value)"
  >

  <hr>

  <!-- ===== SPEED ===== -->
  <label>
    Speed: <span id="speedLabel">1.0×</span>
  </label><br>

  <input
    id="speedSlider"
    type="range"
    min="0.25"
    max="3"
    step="0.05"
    value="1"
    onchange="updateSpeed(this.value)"
  >

  <br><br>

  <!-- Speed Presets -->
  <button onclick="setSpeedPreset(0.5)">0.5×</button>
  <button onclick="setSpeedPreset(1)">1×</button>
  <button onclick="setSpeedPreset(1.5)">1.5×</button>
  <button onclick="setSpeedPreset(2)">2×</button>

  <!-- ========================================================= -->
  <!-- ==================== JAVASCRIPT ========================= -->
  <!-- ========================================================= -->

  <script>
    // ===== BLE GLOBALS =====
    let device;
    let server;
    let service;
    let commandChar;

    const SERVICE_UUID = '12345678-1234-5678-1234-56789abcdef0';
    const CHAR_UUID    = 'abcdef01-1234-5678-1234-56789abcdef0';

    // ===== BLE CONNECT =====
    async function connectBLE() {
      try {
        device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [SERVICE_UUID]
        });

        document.getElementById("deviceName").innerText =
          device.name || "Unknown device";

        server = await device.gatt.connect();
        service = await server.getPrimaryService(SERVICE_UUID);
        commandChar = await service.getCharacteristic(CHAR_UUID);

        document.getElementById("status").innerText = "Connected";
      } catch (e) {
        document.getElementById("status").innerText = "Connection failed";
        alert("BLE failed: " + e);
      }
    }

    // ===== COMMAND SENDER =====
    async function sendCommand(cmd) {
      if (!commandChar) return;
      const encoder = new TextEncoder();
      await commandChar.writeValue(encoder.encode(cmd));
      console.log("Sent:", cmd);
    }

    // ===== BRIGHTNESS (0–100% UI → 0–255 Arduino) =====
    function updateBrightness(percent) {
      document.getElementById("brightnessLabel").innerText = percent + "%";
      const value255 = Math.round((percent / 100) * 255);
      sendCommand(`BRIGHT:${value255}`);
    }

    // ===== SPEED (MULTIPLIER) =====
    function updateSpeed(multiplier) {
      multiplier = parseFloat(multiplier);
      document.getElementById("speedLabel").innerText =
        multiplier.toFixed(2) + "×";
      sendCommand(`SPEED:${multiplier}`);
    }

    function setSpeedPreset(multiplier) {
      const slider = document.getElementById("speedSlider");
      slider.value = multiplier;
      updateSpeed(multiplier);
    }

    // ===== COLOR =====
    function sendColor(hex) {
      const r = parseInt(hex.substring(1,3), 16);
      const g = parseInt(hex.substring(3,5), 16);
      const b = parseInt(hex.substring(5,7), 16);
      sendCommand(`RGB:${r},${g},${b}`);
    }
  </script>
</body>
</html>
