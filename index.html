<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>LED Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(180deg, #0f2027, #203a43, #2c5364);
      color: #fff;
      text-align: center;
    }

    .container {
      max-width: 420px;
      margin: auto;
      padding: 20px;
    }

    .card {
      background: rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
    }

    button {
      background: linear-gradient(135deg, #00c6ff, #0072ff);
      border: none;
      border-radius: 10px;
      color: white;
      padding: 10px 14px;
      margin: 5px;
      font-size: 14px;
      cursor: pointer;
    }

    button.secondary {
      background: linear-gradient(135deg, #444, #222);
    }

    button.active {
      outline: 2px solid #fff;
    }

    button:disabled {
      opacity: 0.4;
    }

    input[type="range"] {
      width: 100%;
    }

    .preset-row {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .label {
      font-size: 14px;
      opacity: 0.85;
      margin-bottom: 6px;
    }

    .status {
      font-size: 13px;
      opacity: 0.85;
    }
  </style>
</head>

<body>
<div class="container">

  <h2>LED Controller</h2>

  <!-- CONNECTION -->
  <div class="card">
    <button onclick="connectBLE()">Connect</button>
    <div class="status">
      Status: <span id="status">Not connected</span><br>
      Device: <span id="deviceName">—</span>
    </div>
  </div>

  <!-- POWER -->
  <div class="card">
    <button onclick="sendCommand('ON')" class="ctl">ON</button>
    <button onclick="sendCommand('OFF')" class="secondary ctl">OFF</button>
  </div>

  <!-- MODES -->
  <div class="card">
    <button onclick="sendCommand('MODE:RAINBOW')" class="ctl">Rainbow</button>
    <button onclick="sendCommand('MODE:CHASE')" class="ctl">Chase</button>
    <button onclick="sendCommand('MODE:BREATH')" class="ctl">Breath</button>
    <button onclick="sendCommand('MODE:AUDIO')" class="ctl">Audio</button>
  </div>

  <!-- COLOR -->
  <div class="card">
    <div class="label">Color</div>
    <input type="color" onchange="sendColor(this.value)" class="ctl">
  </div>

  <!-- BRIGHTNESS -->
  <div class="card">
    <div class="label">Brightness: <span id="brightnessLabel">50%</span></div>
    <input id="brightnessSlider" type="range" min="0" max="100" value="50"
           onchange="updateBrightness(this.value)" class="ctl">

    <div class="preset-row">
      <button onclick="setBrightnessPreset(20)">20%</button>
      <button onclick="setBrightnessPreset(40)">40%</button>
      <button onclick="setBrightnessPreset(60)">60%</button>
      <button onclick="setBrightnessPreset(80)">80%</button>
      <button onclick="setBrightnessPreset(100)">100%</button>
    </div>
  </div>

  <!-- SPEED -->
  <div class="card">
    <div class="label">Speed: <span id="speedLabel">1×</span></div>
    <input id="speedSlider" type="range" min="0.25" max="4" step="0.05" value="1"
           onchange="updateSpeed(this.value)" class="ctl">

    <div class="preset-row">
      <button onclick="setSpeedPreset(0.25)">0.25×</button>
      <button onclick="setSpeedPreset(0.5)">0.5×</button>
      <button onclick="setSpeedPreset(0.75)">0.75×</button>
      <button onclick="setSpeedPreset(1)">1×</button>
      <button onclick="setSpeedPreset(1.5)">1.5×</button>
      <button onclick="setSpeedPreset(2)">2×</button>
      <button onclick="setSpeedPreset(4)">4×</button>
    </div>
  </div>

</div>

<script>
  let device, server, service, commandChar;
  const SERVICE_UUID = '12345678-1234-5678-1234-56789abcdef0';
  const CHAR_UUID    = 'abcdef01-1234-5678-1234-56789abcdef0';

  function setControls(enabled) {
    document.querySelectorAll(".ctl").forEach(e => e.disabled = !enabled);
  }
  setControls(false);

  async function connectBLE() {
    try {
      device = await navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: [SERVICE_UUID]
      });

      document.getElementById("deviceName").innerText = device.name || "Unknown";
      server = await device.gatt.connect();
      service = await server.getPrimaryService(SERVICE_UUID);
      commandChar = await service.getCharacteristic(CHAR_UUID);

      document.getElementById("status").innerText = "Connected";
      setControls(true);
      restoreSettings();
    } catch (e) {
      alert("BLE failed: " + e);
    }
  }

  function sendCommand(cmd) {
    if (!commandChar) return;
    commandChar.writeValue(new TextEncoder().encode(cmd));
  }

  function updateBrightness(p) {
    document.getElementById("brightnessLabel").innerText = p + "%";
    localStorage.setItem("brightness", p);
    sendCommand(`BRIGHT:${Math.round(p * 2.55)}`);
    highlightPreset("brightness", p);
  }

  function setBrightnessPreset(p) {
    brightnessSlider.value = p;
    updateBrightness(p);
  }

  function updateSpeed(v) {
    v = parseFloat(v);
    document.getElementById("speedLabel").innerText = v + "×";
    localStorage.setItem("speed", v);
    sendCommand(`SPEED:${v}`);
    highlightPreset("speed", v);
  }

  function setSpeedPreset(v) {
    speedSlider.value = v;
    updateSpeed(v);
  }

  function sendColor(hex) {
    localStorage.setItem("color", hex);
    const r = parseInt(hex.substr(1,2),16);
    const g = parseInt(hex.substr(3,2),16);
    const b = parseInt(hex.substr(5,2),16);
    sendCommand(`RGB:${r},${g},${b}`);
  }

  function restoreSettings() {
    if (localStorage.brightness) setBrightnessPreset(localStorage.brightness);
    if (localStorage.speed) setSpeedPreset(localStorage.speed);
    if (localStorage.color) sendColor(localStorage.color);
  }

  function highlightPreset(type, value) {
    document.querySelectorAll(`.${type}-preset`)?.forEach(b => b.classList.remove("active"));
  }
</script>
</body>
</html>
