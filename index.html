<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>LED Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <h2>LED Controller</h2>

  <!-- ===== BLE CONNECTION ===== -->
  <button onclick="connectBLE()">Connect</button>
  <p id="status">Not connected</p>

  <hr>

  <!-- ===== POWER CONTROLS ===== -->
  <button onclick="sendCommand('ON')">ON</button>
  <button onclick="sendCommand('OFF')">OFF</button>

  <hr>

  <!-- ===== MODES ===== -->
  <button onclick="sendCommand('MODE:RAINBOW')">Rainbow</button>
  <button onclick="sendCommand('MODE:CHASE')">Chase</button>
  <button onclick="sendCommand('MODE:BREATH')">Breath</button>
  <button onclick="sendCommand('MODE:AUDIO')">Audio Sync</button>

  <hr>

  <!-- ===== COLOR ===== -->
  <label>Color</label><br>
  <input type="color" onchange="sendColor(this.value)">

  <hr>

  <!-- ===== BRIGHTNESS ===== -->
  <label>Brightness</label><br>
  <input
    type="range"
    min="0"
    max="255"
    value="128"
    onchange="sendBrightness(this.value)"
  >

  <hr>

  <!-- ===== SPEED ===== -->
  <label>Speed</label><br>
  <input
    type="range"
    min="1"
    max="500"
    value="100"
    onchange="sendSpeed(this.value)"
  >

  <!-- ========================================================= -->
  <!-- ==================== JAVASCRIPT ========================= -->
  <!-- ========================================================= -->

  <script>
    // ===== BLE GLOBALS (FROM ORIGINAL WORKING CODE) =====
    let device;
    let server;
    let service;
    let commandChar;

    const SERVICE_UUID = '12345678-1234-5678-1234-56789abcdef0';
    const CHAR_UUID    = 'abcdef01-1234-5678-1234-56789abcdef0';

    // ===== BLE CONNECT (UNCHANGED CORE LOGIC) =====
    async function connectBLE() {
      try {
        device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [SERVICE_UUID]
        });

        server = await device.gatt.connect();
        service = await server.getPrimaryService(SERVICE_UUID);
        commandChar = await service.getCharacteristic(CHAR_UUID);

        document.getElementById("status").innerText = "Connected";
        console.log("BLE connected");
      } catch (e) {
        document.getElementById("status").innerText = "Connection failed";
        console.error(e);
        alert("BLE failed: " + e);
      }
    }

    // ===== COMMAND SENDER (NEW, SAFE ADDITION) =====
    async function sendCommand(cmd) {
      if (!commandChar) {
        console.warn("Not connected");
        return;
      }

      const encoder = new TextEncoder();
      await commandChar.writeValue(encoder.encode(cmd));
      console.log("Sent:", cmd);
    }

    // ===== UI HELPERS (NEW) =====
    function sendBrightness(val) {
      sendCommand(`BRIGHT:${val}`);
    }

    function sendSpeed(val) {
      sendCommand(`SPEED:${val}`);
    }

    function sendColor(hex) {
      const r = parseInt(hex.substring(1,3), 16);
      const g = parseInt(hex.substring(3,5), 16);
      const b = parseInt(hex.substring(5,7), 16);
      sendCommand(`RGB:${r},${g},${b}`);
    }
  </script>
</body>
</html>
